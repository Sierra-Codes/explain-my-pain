<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Explain My Pain</title>
  <style>
  :root {
    --indigo:#8c6eb0;
    --indigo-dark:#77589f;
    --bg:#f8f6fc;
    --ink:#2d2d2d;
    --muted:#666;
    --line:#e4def1;
  }
  *{box-sizing:border-box}
  body {
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";
  }
  .container{max-width:960px;margin:0 auto;padding:24px}
  h1,h2,h3{color:var(--indigo);margin:0 0 .6rem}
  .lead{margin:.4rem 0 1.25rem;}
  .card{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    padding:16px 18px;
    margin:12px 0
  }
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  label{display:block;font-weight:600;margin:.25rem 0 .25rem}
  select,textarea,input[type="text"]{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid #d9d3ea;
    background:#fff
  }
  textarea{min-height:110px;resize:vertical}
  .btn{
    display:inline-block;
    background:var(--indigo);
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:12px;
    cursor:pointer;
    font-weight:600
  }
  .btn.secondary{background:#fff;color:var(--indigo);border:1px solid var(--indigo)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .helper{color:var(--muted);font-size:.9rem}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{
    display:inline-block;
    border:1px solid var(--line);
    border-radius:999px;
    padding:4px 10px;
    margin:4px 6px 0 0;
    background:#faf7ff
  }
  .hidden{display:none}
  .list{margin:0;padding-left:1.25rem}
  .bullets{margin:.25rem 0 .25rem}
  .footer-note{color:var(--muted);font-size:.9rem;margin-top:6px}
  .section-title{display:flex;align-items:center;gap:8px}
  .hr{height:1px;background:var(--line);border:0;margin:12px 0}
  .cta-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pillbox {
    display:flex;
    flex-wrap:wrap;
    gap:.5rem;
    margin-top:.5rem;
  }
  .pill {
    border:1px solid var(--line);
    border-radius:999px;
    padding:.4rem .9rem;
    font-size:.9rem;
    cursor:pointer;
    background:#fff;
    transition:background .15s ease, color .15s ease, border-color .15s ease, transform .03s ease;
  }
  .pill:hover { transform: translateY(-1px); }
  .pill input { display:none }
  .pill.active {
    background:var(--indigo);
    color:#fff;
    border-color:var(--indigo);
  }
  .pill:focus-within {
    outline:2px solid var(--indigo-dark);
    outline-offset:2px;
    border-color:var(--indigo-dark);
  }
  #patientOut strong, #clinicianOut strong { color: var(--indigo); }
  #patientOut { line-height: 1.6; margin-bottom: .75rem; }
  #patientOut p { margin: 0.75rem 0; line-height: 1.6; }
  #clinicianOut { line-height: 1.6; }
  #researchBlock .footer-note a { color: var(--indigo); text-decoration: underline; }
  #entailList { list-style: disc; padding-left: 1.25rem; }
  #entailList li { margin: .25rem 0; }
  </style>
</head>
<body>
  <main class="container">
    <!-- Intro block -->
    <header class="card">
      <h1>Explain My Pain</h1>
      <p class="lead">
        Explaining invisible pain is hard, especially when linked to ‚Äúnatural‚Äù processes like menstruation.
        Too often, pain is normalised, dismissed, or misunderstood.
      </p>
      <p>
        This app was created by a linguist and researcher with lived experience of endometriosis pain.
        Its purpose is simple: to give you words when words fail. </p>
        <p> 
        Select the descriptions that you feel best match how your pain feels. The app will explain them
        in plain language and will create a short summary to share with your clinician.
      </p>
      <p style="text-align:center;color:var(--indigo);font-style:italic;margin:.6rem 0 .2rem">
        üíú I hope this app helps you explain your pain and feel heard.
      </p>
      <div style="border-left:4px solid var(--indigo-dark); padding-left:10px; margin-top:.6rem">
        <p class="footer-note" style="margin:.25rem 0 0">
          <strong>Disclaimer:</strong> This tool is <strong>not diagnostic</strong> and does not replace medical advice.
          It is designed only as a communication aid, to help bridge the gap between patient experience and medical language.
        </p>
      </div>
      <p class="footer-note" style="margin-top:.6rem">
        <a href="https://stellabullo.com/writing/language-of-endo/" target="_blank" rel="noopener" style="color:var(--indigo);text-decoration:underline">
          Learn more about the project ‚Üí
        </a>
      </p>
    </header>

    <form id="empForm" class="card" method="POST" action="/analyze">
      <!-- Context -->
      <section class="card">
        <div class="grid-2">
          <div>
            <label for="name">Your name (optional)</label>
            <input type="text" id="name" name="name" placeholder="e.g., Stella"/>
          </div>
          <div>
            <label for="duration">How long has this been going on? (optional)</label>
            <input type="text" id="duration" name="duration" placeholder="e.g., 6 months, since 2022"/>
          </div>
        </div>
      </section>

      <!-- Core selectors -->
      <section class="card">
        <div class="grid-2">
          <div>
            <label for="trigger">When does it happen?</label>
            <select id="trigger" name="trigger" required>
              <option value="">Choose a trigger</option>
              <option>Menstruation</option>
              <option>Ovulation</option>
              <option>Sex / Intercourse</option>
              <option>Going to the toilet ‚Äì urination</option>
              <option>Going to the toilet ‚Äì bowel emptying</option>
              <option>Daily life / Background</option>
              <option>Physical activity</option>
              <option>Sleep / Rest</option>
            
            </select>
          </div>

          <div>
            <label for="category">What does it feel like?</label>
            <select id="category" name="category" required>
              <option value="">Choose a category</option>
              <!-- Populated by JS from taxonomy -->
            </select>
          </div>
        </div>

        <div class="grid-2">
          <div>
            <label for="expression">I feel as if‚Ä¶</label>
            <select id="expression" name="expression" disabled required>
              <option value="">I feel as if‚Ä¶ e.g., ‚ÄúI‚Äôm being stabbed repeatedly‚Äù</option>
            </select>
            <div id="hint" class="footer-note hidden"></div>
            <div id="hintNote" class="footer-note hidden"></div>
          </div>
          <div class="cta-row" style="align-items:flex-end">
            <button type="button" id="addBtn" class="btn">Use this description‚Ä¶</button>
            <button type="button" id="clearBtn" class="btn secondary">Clear selection</button>
          </div>
        </div>
      </section>

      <!-- Preview of selections -->
      <section class="card">
        <div class="section-title"><h2>What you‚Äôve added</h2></div>
        <div id="emptyListNote" class="footer-note">No items yet.</div>
        <div id="groupedChips" class="row"></div>
      </section>

      <!-- Overall + QoL (pill style, always visible) -->
<section class="card" id="overall-optional">
  <h2>Overall / baseline (optional)</h2>

  <div class="grid-2" style="margin-top:.5rem">
    <!-- QoL IMPACTS -->
    <fieldset class="card" style="margin:0">
      <label class="section-title" style="margin-bottom:.25rem">
        I feel that this pain‚Ä¶ (tap as many as apply)
      </label>
      <div class="pillbox">
        <label class="pill"><input type="checkbox" name="qolOpt" value="Dominates my life">Dominates my life</label>
        <label class="pill"><input type="checkbox" name="qolOpt" value="Affects me socially">Affects me socially</label>
        <label class="pill"><input type="checkbox" name="qolOpt" value="Affects my productivity">Affects my productivity</label>
        <label class="pill"><input type="checkbox" name="qolOpt" value="Prevents me from carrying out basic chores">Prevents me from carrying out basic chores</label>
        <label class="pill"><input type="checkbox" name="qolOpt" value="Affects my mental health">Affects my mental health</label>
        <label class="pill"><input type="checkbox" name="qolOpt" value="Affects my happiness">Affects my happiness</label>
      </div>
    </fieldset>

    <!-- OVERALL FEELINGS -->
    <fieldset class="card" style="margin:0">
      <label class="section-title" style="margin-bottom:.25rem">Overall....(tap as many as apply)</label>
      <div class="pillbox">
        <label class="pill"><input type="checkbox" name="overallOpt" value="I feel isolated">I feel isolated</label>
        <label class="pill"><input type="checkbox" name="overallOpt" value="I feel drained and exhausted">I feel drained and exhausted</label>
        <label class="pill"><input type="checkbox" name="overallOpt" value="I feel like I am losing myself">I feel like I am losing myself</label>
        <label class="pill"><input type="checkbox" name="overallOpt" value="I feel overwhelmed">I feel overwhelmed</label>
        <label class="pill"><input type="checkbox" name="overallOpt" value="I feel anxious or worried">I feel anxious or worried</label>
        <label class="pill"><input type="checkbox" name="overallOpt" value="My mood is low / I feel down">My mood is low / I feel down</label>
      </div>
    
    </fieldset>
  </div>
</section>



      <!-- Hidden payloads sent to backend -->
      <textarea name="description" id="constructedText" class="hidden"></textarea>
      <input type="hidden" id="overallHidden" name="overall" />
      <input type="hidden" id="qolHidden" name="qol" />

      <!-- Submit -->
      <section class="card">
        <div class="cta-row">
          <button type="submit" id="submitBtn" class="btn" formnovalidate>Continue</button>
          <span class="footer-note">We‚Äôll build both patient and clinician summaries.</span>
        </div>
      </section>
    </form>

    <!-- Output -->
    <section class="card">
      <h2>This is your pain explained</h2>
      <div id="patientOut" class="footer-note">The summary will appear here after submission.</div>
      <div class="hr"></div>
      <h3>Notes your doctor may find useful</h3>
      <div id="clinicianOut" class="footer-note">We‚Äôll include triggers, salient metaphors, and entailments.</div>
      <div class="hr"></div>
    </section>
   
  </main>

<script>
  /* ===========================
     Explain My Pain ‚Äî Frontend
     Stella Bullo, 2025
     =========================== */

  // ----- Data handles -----
  const TYPES = {{ taxonomy.get("metaphor_types", {}) | tojson }};

  // ----- DOM refs -----
  const triggerSel    = document.getElementById('trigger');
  const catSel        = document.getElementById('category');
  const expSel        = document.getElementById('expression');
  const addBtn        = document.getElementById('addBtn');
  const clearBtn      = document.getElementById('clearBtn');

  const groupedChips  = document.getElementById('groupedChips');
  const emptyNote     = document.getElementById('emptyListNote');
  const hint          = document.getElementById('hint');
  const hintNote      = document.getElementById('hintNote');

  const constructedText = document.getElementById('constructedText');

  const patientOut    = document.getElementById('patientOut');
  const clinicianOut  = document.getElementById('clinicianOut');

  // Local state
  const selections = []; // [{ trigger, category, expression }]

  // -------- Canonical clinician headings + synonyms (used to normalise & dedupe) --------
const CANON_HEADINGS = {
  "Menstruation-related pain": [
    /Menstruation[-\s]related pain/i, /Menstrual pain/i
  ],
  "Ovulation-related pain": [
    /Ovulation[-\s]related pain/i, /Ovulation pain/i
  ],
  "Dyspareunia (pain with intercourse)": [
    /Dyspareunia.*intercourse/i, /Pain with intercourse/i, /Sex pain/i
  ],
  "Pain with urination": [
    /Pain with urination/i, /Urinary pain/i
  ],
  "Bowel-related pain": [
    /Bowel[-\s]related pain/i,
    /Pain with bowel movements/i,
    /Pain with defecation/i,
    /Defecation[-\s]related pain/i,
    /Defecation pain/i,
    /Bowel.*pain/i
  ],
  "Background pain (rest of the month)": [
    /Background pain.*month/i, /Chronic baseline pain/i, /Background pain/i
  ],
  "Pain with physical activity": [
    /Pain with physical activity/i, /Activity pain/i, /Exercise pain/i
  ],
  "Pain with sleep\/rest": [
    /Pain with sleep\/rest/i, /Sleep.*pain/i, /Rest pain/i
  ]
};


  const TRIGGER_HEADINGS = {
  "Menstruation": "Menstruation-related pain",
  "Ovulation": "Ovulation-related pain",
  "Sex / Intercourse": "Dyspareunia (pain with intercourse)",
  "Going to the toilet ‚Äì urination": "Pain with urination",
  "Going to the toilet ‚Äì bowel emptying": "Bowel-related pain",
  "Daily life / Background": "Background pain (rest of the month)",
  "Physical activity": "Pain with physical activity",
  "Sleep / Rest": "Pain with sleep/rest"
};

  const TRIGGER_ORDER = [
    "Menstruation",
    "Ovulation",
    "Sex / Intercourse",
    "Going to the toilet ‚Äì urination",
    "Going to the toilet ‚Äì bowel emptying",
    "Daily life / Background",
    "Physical activity",
    "Sleep / Rest"
  ];

  // -------- Metaphor explanations (fallback) --------
  const META_NOTES = {
    violent_action: "Intrusive/assault imagery reflects episodes that feel severe and violating; often used for flares.",
    cutting_tools: "Sharp ‚Äòcutting‚Äô imagery can reflect focal, intrusive pain and sometimes neuropathic components.",
    internal_machinery: "‚ÄòGears/clamps/drills‚Äô can signal cramping/ratcheting sensations and sometimes adhesions.",
    constriction_pressure: "Constricting/tightening metaphors may reflect internal pressure or muscle spasm (e.g., uterine contractions, pelvic floor tension, bowel/bladder spasm).",
    electric_force: "Electric or ‚Äòzapping‚Äô sensations often align with nerve irritation or heightened visceral sensitivity.",
    weight_burden: "Heaviness/burden imagery fits fatigue, inflammatory load, or a ‚Äòdragging‚Äô pelvic sensation.",
    heat: "Burning/scalding imagery can accompany inflammatory flares or sensitised tissue.",
    birth_labour: "Labour-like waves suggest uterine/ovarian origin and cyclical surges.",
    lingering_force: "Background ‚Äòthrobbing/simmering‚Äô describes persistent, lower-grade pain between flares.",
    predator: "Predator imagery often captures anticipatory fear and hypervigilance around pain.",
    entrapment: "‚ÄòTrapped/locked-in‚Äô metaphors are common with chronicity and reduced sense of control.",
    transformation_distortion: "Distortion/identity-change metaphors speak to the psychosocial impact of long-term pain."
  };

  /* ---------- Helpers ---------- */

  function initCategories(){
    const cats = Object.keys(TYPES || {})
      .filter(c => c !== "literal")
      .sort();
    catSel.innerHTML = '<option value="">Choose a category</option>' +
      cats.map(c=>`<option value="${c}">${c.replaceAll('_',' ')}</option>`).join('');
  }

  function toSentence(arr){
    if (!arr?.length) return "";
    if (arr.length === 1) return arr[0];
    return arr.slice(0, -1).join(", ") + " and " + arr[arr.length - 1];
  }

  function refreshExpressions(){
    expSel.innerHTML = '<option value="">I feel as if‚Ä¶ e.g., ‚ÄúI‚Äôm being stabbed repeatedly‚Äù</option>';
    expSel.disabled = true;
    hint.classList.add('hidden');  hint.textContent = '';
    hintNote.classList.add('hidden');
    const cat = catSel.value;
    if (!cat || !TYPES[cat]) return;
    (TYPES[cat].expressions || []).forEach(e=>{
      const opt = document.createElement('option');
      opt.value = e; opt.textContent = e;
      expSel.appendChild(opt);
    });
    expSel.disabled = false;
  }

  function refreshHint(){
    hint.classList.add('hidden');  hint.textContent = '';
    hintNote.classList.add('hidden');
    const cat = catSel.value;
    if (!cat || !TYPES[cat]) return;
    const h = TYPES[cat].hint || '', note = TYPES[cat].note || '';
    if (h){ hint.textContent = h; hint.classList.remove('hidden'); }
    if (note){ hintNote.textContent = note; hintNote.classList.remove('hidden'); }
  }

  function refreshControls(){
    addBtn.disabled = !(triggerSel.value && catSel.value && expSel.value);
  }

  function groupByTrigger(items){
    const map = new Map();
    items.forEach(i=>{
      if (!map.has(i.trigger)) map.set(i.trigger, []);
      map.get(i.trigger).push(i);
    });
    return map;
  }

  function renderGroupedPreview(){
    groupedChips.innerHTML = '';
    if (!selections.length){ emptyNote.classList.remove('hidden'); return; }
    emptyNote.classList.add('hidden');
    const grouped = groupByTrigger(selections);
    for (const [trigger, items] of grouped.entries()){
      const h = document.createElement('div');
      h.innerHTML = `<strong>${trigger}:</strong>`;
      groupedChips.appendChild(h);
      const unique = new Set(items.map(i=>`${i.expression} (${i.category.replaceAll('_',' ')})`));
      for (const txt of unique){
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = txt;
        groupedChips.appendChild(chip);
      }
    }
  }

  function maybeAddPendingSelection(){
    const t = triggerSel.value, c = catSel.value, e = expSel.value;
    if (!(t && c && e)) return;
    if (selections.some(s => s.trigger===t && s.category===c && s.expression===e)) return;
    selections.push({ trigger:t, category:c, expression:e });
    renderGroupedPreview();
    triggerSel.value=''; catSel.value=''; expSel.value='';
    refreshExpressions(); refreshHint(); refreshControls();
  }

  function getCheckedValues(name){
    return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
      .map(el => el.value.trim()).filter(Boolean);
  }
  const getQolSelections = ()=> getCheckedValues('qolOpt');

  function buildConstructedText(){
    const grouped = groupByTrigger(selections);
    const parts = [];
    for (const [trigger, items] of grouped.entries()){
      const exps = Array.from(new Set(items.map(i=>i.expression)));
      parts.push(`During ${trigger}: ${toSentence(exps)}.`);
    }
    const overallArr = getCheckedValues('overallOpt');
    if (overallArr.length) parts.push(`Overall: ${toSentence(overallArr)}.`);
    const qol = getQolSelections();
    if (qol.length) parts.push(`Quality of life: ${toSentence(qol)}.`);
    constructedText.value = parts.join(" ");
    document.getElementById('overallHidden').value = overallArr.join(", ");
    document.getElementById('qolHidden').value     = qol.join(", ");
  }

  function renderMD(str){
    if (!str) return "";
    const esc = str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    return esc
      .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
      .replace(/\*(.+?)\*/g, "<em>$1</em>")
      .replace(/\n{2,}/g, "<br><br>")
      .replace(/\n/g, "<br>");
  }

  function toParagraphs(html){
    return html
      .split(/<br\s*\/?>/i).map(s => s.trim()).filter(Boolean)
      .map(s => `<p>${s}</p>`).join("");
  }

  // --- Evidence link target (use "/evidence" if you added the Flask route; else "/static/evidence.html") ---
  const EVIDENCE_URL = "/evidence";

  function linkifyEvidence(html){
    let out = html.replace(/\/evidence\b/gi, `<a href="${EVIDENCE_URL}" target="_blank" rel="noopener">evidence</a>`);
    if (!out.includes(EVIDENCE_URL)) {
      out = out.replace(/\bevidence\b/gi, `<a href="${EVIDENCE_URL}" target="_blank" rel="noopener">evidence</a>`);
    }
    return out;
  }

  // ---- Normalisation & de-duplication of clinician headings ----
  function replaceAllSynonymsWithCanonical(html){
    for (const [canon, pats] of Object.entries(CANON_HEADINGS)){
      pats.forEach(rx=>{
        html = html.replace(new RegExp(`<strong>\\s*${rx.source}\\s*</strong>`, 'i'), `<strong>${canon}</strong>`);
      });
    }
    return html;
  }
  function hasSection(html, canon){
    const pats = CANON_HEADINGS[canon] || [];
    return pats.some(rx => rx.test(html)) || new RegExp(`<strong>\\s*${canon}\\s*</strong>`, 'i').test(html);
  }

  function buildMissingSectionsHTML(){
    const grouped = groupByTrigger(selections);
    let out = "";
    TRIGGER_ORDER.forEach(trig => {
      if (!grouped.has(trig)) return;
      const canon = TRIGGER_HEADINGS[trig];
      if (hasSection(clinicianOut.innerHTML, canon)) return; // already there (possibly normalised)
      const items = grouped.get(trig);
      const cats  = Array.from(new Set(items.map(i=>i.category)));
      const notes = cats.map(c => META_NOTES[c]).filter(Boolean).join(' ');
      out += `<p><strong>${canon}</strong><br>${notes || "Metaphor patterns were recorded for this context."}</p>`;
    });
    return out;
  }

  function injectMissingSectionsInOrder(){
    // 1) normalise existing headings first (so we don't double-insert)
    clinicianOut.innerHTML = replaceAllSynonymsWithCanonical(clinicianOut.innerHTML);

    // 2) add any missing sections before the evidence paragraph (if present)
    const addHtml = buildMissingSectionsHTML();
    if (!addHtml) return;

    let html = clinicianOut.innerHTML;
    const evParaRx = new RegExp(`(<p[^>]*>[^<]*evidence[^<]*</a>.*?</p>)`,'i');
    const m = html.match(evParaRx);
    if (m) html = html.replace(evParaRx, addHtml + m[1]); else html += addHtml;
    clinicianOut.innerHTML = html;
  }

  

  // ---- Pronoun transforms for Overall/QoL ----
  function csvToList(str){ return str.split(',').map(s=>s.trim()).filter(Boolean); }
  function stripIFeel(s){ return s.replace(/^I\s+feel\s+/i,'').replace(/^I\s+/i,''); }
  function toSecondPerson(s){
    return s.replace(/\bMy\b/g,'Your').replace(/\bmy\b/g,'your').replace(/\bme\b/g,'you').replace(/\bI\b/g,'you');
  }
  function toThirdPerson(s){
    return s.replace(/\bMy\b/g,'their').replace(/\bmy\b/g,'their').replace(/\bme\b/g,'them').replace(/\bI\b/g,'the patient');
  }

  // ---- UI wiring ----
  function initPills(){
    document.querySelectorAll('.pill input').forEach(inp=>{
      inp.closest('.pill').classList.toggle('active', inp.checked);
      inp.addEventListener('change', ()=>{
        inp.closest('.pill').classList.toggle('active', inp.checked);
      });
    });
  }

  function initSubmit(){
    document.getElementById('empForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      maybeAddPendingSelection();
      buildConstructedText();

      if (!constructedText.value.trim()) {
        patientOut.textContent  = "Add at least one description or select some Overall / Quality of life options.";
        clinicianOut.textContent = "";
        return;
      }

      const form = e.currentTarget;
      const fd   = new FormData(form);

      try {
        const resp = await fetch(form.action, { method: "POST", body: fd });
        const data = await resp.json();

        // Patient
        const patientText =
          data.patient || (data.results && data.results.patient) || "No patient summary produced.";
        patientOut.innerHTML = toParagraphs(renderMD(patientText));

        // Clinician (render + evidence link)
        const doctorText  =
          data.doctor  || (data.results && data.results.doctor)  || "No clinician notes produced.";
        clinicianOut.innerHTML = linkifyEvidence(renderMD(doctorText));

        // Order + dedupe clinician sections
        injectMissingSectionsInOrder();
        ensureSingleMetaphorBlock();

        // Overall/QoL
        const overallRaw = (document.getElementById('overallHidden').value || "").trim();
        const qolRaw     = (document.getElementById('qolHidden').value || "").trim();
        const overallList = csvToList(overallRaw).map(stripIFeel);

        // Patient (2nd person)
        const patientOverall = overallList.length ? `Overall, you feel ${toSentence(overallList.map(toSecondPerson))}.` : "";
        const patientQoL = qolRaw ? `Quality of life: ${toSecondPerson(qolRaw)}.` : "";
        if (patientOverall || patientQoL){
          patientOut.innerHTML += "<p></p>" + toParagraphs(renderMD([patientOverall, patientQoL].filter(Boolean).join(" ")));
        }

        // Doctor (3rd person, at bottom)
        const doctorOverall = overallList.length ? `Overall, the patient feels ${toSentence(overallList.map(toThirdPerson))}.` : "";
        const doctorQoL = qolRaw ? `Quality of life impact: ${toThirdPerson(qolRaw)}.` : "";
        if (doctorOverall || doctorQoL){
          clinicianOut.innerHTML += "<br><br>" + renderMD([doctorOverall, doctorQoL].filter(Boolean).join(" "));
        }

        

        // Ensure one evidence link exists
        if (!clinicianOut.innerHTML.includes(EVIDENCE_URL)) {
          clinicianOut.innerHTML += `<p>For more information, see the evidence page: <a href="${EVIDENCE_URL}" target="_blank" rel="noopener">evidence</a>.</p>`;
        }

      } catch (err) {
        console.error(err);
        patientOut.textContent  = "There was an error analyzing your description.";
        clinicianOut.textContent = "";
      }
    });
  }

  /* ---------- Wire up events ---------- */
  catSel.addEventListener('change', ()=>{ refreshExpressions(); refreshHint(); refreshControls(); });
  expSel.addEventListener('change', ()=>{ refreshControls(); });
  triggerSel.addEventListener('change', ()=>{ refreshControls(); });

  clearBtn.addEventListener('click', ()=>{
    triggerSel.value=''; catSel.value=''; expSel.value='';
    refreshExpressions(); refreshHint(); refreshControls();
  });

  addBtn.addEventListener('click', ()=>{ maybeAddPendingSelection(); });

  /* ---------- Boot ---------- */
  initCategories();
  refreshExpressions();
  refreshHint();
  refreshControls();
  initPills();
  initSubmit();
</script>



</body>
</html>
